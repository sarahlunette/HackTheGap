version: "3.9"

services:
  # -------------------------------
  # QDRANT VECTOR DB
  # -------------------------------
  qdrant_db:
    image: qdrant/qdrant:v1.12.5
    container_name: qdrant_db
    restart: unless-stopped
    environment:
      QDRANT__STORAGE__STORAGE_PATH: "/qdrant/storage"
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant_storage:/qdrant/storage
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/healthz"]
      interval: 5s
      timeout: 3s
      retries: 40
      start_period: 5s

  # -------------------------------
  # FASTAPI + RAG + CLAUDE/MISTRAL
  # -------------------------------
  resilience_api:
    build:
      context: .
      dockerfile: app/Dockerfile
    image: resilience_app:latest        # image réutilisée pour vectorstore_builder
    container_name: resilience_api
    restart: unless-stopped
    depends_on:
      qdrant_db:
        condition: service_healthy
    environment:
      QDRANT_URL: http://qdrant_db:6333
      CLAUDE_API_KEY: ${CLAUDE_API_KEY}
      MISTRAL_API_KEY: ${MISTRAL_API_KEY}
      HF_TOKEN: ${HF_TOKEN}
      AUTH_MODE: ${AUTH_MODE:-basic}
      MVP_USER: ${MVP_USER:-admin}
      MVP_PASS: ${MVP_PASS:-password}
    command: ["executable", "arg"]
    ports:
      - "8000:8000"
    volumes:
      # docs et exports de l'app
      - ./app/docs:/app/docs
      - ./app/exports:/app/exports
      # modèle local pour ../models/all-MiniLM-L6-v2
      - ./models:/models

  # -------------------------------
  # MCP SERVER (FastMCP + tools)
  # -------------------------------
  mcp_server:
    build:
      context: .
      dockerfile: mcp_server/Dockerfile
    container_name: mcp_server
    restart: unless-stopped
    depends_on:
      qdrant_db:
        condition: service_healthy
    environment:
      QDRANT_URL: http://qdrant_db:6333
      HF_TOKEN: ${HF_TOKEN}
      CLAUDE_API_KEY: ${CLAUDE_API_KEY}
      MISTRAL_API_KEY: ${MISTRAL_API_KEY}
    volumes:
      # code du MCP server
      - ./mcp_server:/mcp
      # accès au code de l'app pour build_vectorstore.py appelé depuis l'outil MCP
      - ./app:/mcp/app
      # modèles locaux
      - ./models:/mcp/models
      # docs de l'app (où l'outil Earth Engine écrit ses JSON)
      - ./app/docs:/mcp/app/docs
    ports:
      - "9000:9000"   # adapte si ton MCP écoute sur un autre port

volumes:
  qdrant_storage:
